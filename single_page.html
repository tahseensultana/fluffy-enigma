<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rental Manager Single Page</title>
    <style>
        /* Shared Styles for all views */
        body { font-family: Arial, sans-serif; margin: 20px; }
        nav a { margin-right: 15px; text-decoration: none; color: #007bff; font-weight: bold; }
        nav a:hover { text-decoration: underline; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; }
        .late { color: red !important; font-weight: bold; }
        
        /* Dashboard Specific Styles (Pure CSS :target solution) */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: #f4f4f9; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-card h3 { margin-top: 0; color: #333; }
        .stat-card p { font-size: 2em; font-weight: bold; }
        
        /* CSS Targeting Styles for the Dashboard Detail Panel */
        .static-detail-panel {
            display: none; /* Hidden by default */
            border: 2px solid #007bff;
            padding: 20px;
            margin-top: 5px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #f8faff;
        }
        /* When the URL hash matches a panel's ID, display it */
        .static-detail-panel:target {
            display: block;
        }
        /* Ensure links inside table cells don't break the layout */
        .property-row a { 
            text-decoration: none; 
            color: #007bff; /* Make the clickable link blue */
            font-weight: bold;
        }
        .property-row a:hover {
            text-decoration: underline;
        }
        /* Form/Control Specific Styles */
        .controls { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
        .controls div { border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
        input[type="text"], input[type="number"], input[type="date"], input[type="month"], select { padding: 5px; border: 1px solid #ccc; border-radius: 3px; }
        button { padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button.remove { background-color: #dc3545; }
    </style>
</head>
<body>
    <h1>üè† Rental Manager System</h1>

    <nav>
        <a href="{{ url_for('single_page_app', page='index') }}">Dashboard</a>
        <a href="{{ url_for('single_page_app', page='properties') }}">Properties & Tenants</a>
    </nav>
    <hr>

    {% if page == 'index' %}
        <div style="margin-bottom: 20px;">
            <form method="GET" action="{{ url_for('single_page_app', page='index') }}">
                <h2>Viewing Records for: 
                    <input type="month" name="month" 
                           value="{{ current_display_month }}" 
                           onchange="this.form.submit()">
                </h2>
            </form>
        </div>
        
        <h2>Current Month Summary</h2>
        <div class="stats-grid" >
            <div class="stat-card">
                <h3>Total Collected (Month)</h3>
                <p>${{ '{:,.2f}'.format(total_collected) }}</p>
            </div>
        </div>

        <h2>Property Management Hub </h2>        
        <table>
            <thead>
                <tr>
                    <th>Address</th><th>Monthly Rent</th><th>Current Tenant</th><th>Current Status</th><th>Amount Paid</th>
                </tr>
            </thead>
            <tbody>
                {% for prop in properties_data %}
                <tr class="property-row">
                    <td>
                        <a href="#details-{{ prop.PropertyID }}">
                            {{ prop.Address }} 
                        </a>
                    </td>
                    <td>${{ '{:,.2f}'.format(prop.MonthlyRent) }}</td>
                    <td>
                        {{ prop.TenantName if prop.TenantName else 'VACANT' }}
                        {% if prop.TenantName %}<small>({{ prop.ContactNumber }})</small>{% endif %}
                    </td>
                    <td class="{{ 'late' if prop.CurrentStatus == 'Late' else '' }}">
                        {{ prop.CurrentStatus if prop.CurrentStatus else 'DUE' }}
                    </td>
                    <td>{{ '${:,.2f}'.format(prop.AmountPaid) if prop.AmountPaid else 'N/A' }}</td>
                </tr>
                
                <tr>
                    <td colspan="5" style="padding: 0; border: none;">
                        <div id="details-{{ prop.PropertyID }}" class="static-detail-panel">    
                            <h3>Details: {{ prop.Address }} <small><a href="#">[Close Details]</a></small></h3>
                                <h4>Current Tenant Details</h4>
                                <div style="margin-bottom: 5px;">
                                    <label style="font-weight: normal;">Displaying Payment for:</label> 
                                    <strong>{{ prop.ExpectedDueDate|default('')|truncate(7, killwords=True, end='') or 'N/A' }}</strong>
                                </div>
                                <div style="margin-bottom: 5px;">
                                    <label style="font-weight: normal;">Tenant Name:</label> 
                                    <strong>{{ prop.TenantName|default('VACANT') }}</strong> ({{ prop.ContactNumber|default('N/A') }})
                                </div>                    
                            <form method="POST" action="/record_payment/{{ prop.CurrentPaymentID }}">
                                <h4>Payment Status Update</h4>
                                <div style="margin-bottom: 10px;">
                                    <label>Expected Rent:</label> <span>${{ '{:,.2f}'.format(prop.MonthlyRent) }}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label for="date_paid_{{ prop.PropertyID }}">Date Paid:</label>
                                    <input type="date" id="date_paid_{{ prop.PropertyID }}" name="date_paid" value="{{ prop.DatePaid|default(today) }}" required>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label for="amount_paid_{{ prop.PropertyID }}">Amount Paid:</label>
                                    <input type="number" step="0.01" id="amount_paid_{{ prop.PropertyID }}" name="amount_paid" 
                                           value="{{ '{:,.2f}'.format(prop.AmountPaid) if prop.AmountPaid else '{:,.2f}'.format(prop.MonthlyRent) }}" required>
                                </div>
                                {% if prop.CurrentPaymentID %}
                                    <button type="submit">‚úÖ Record Payment</button>
                                {% else %}
                                    <button type="button" disabled>ERROR: Missing Payment Record</button>
                                {% endif %}
                                <small style="margin-left: 20px;">Current Status: {{ prop.CurrentStatus|default('N/A') }}</small>
                            </form>

                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        

    {% elif page == 'properties' %}
        <h2>Property and Tenant Management</h2>
        <div class="controls">
            <div>
                <h3>Add New Property</h3>
                <p>
                    <a href="{{ url_for('single_page_app', page='add_property') }}">
                        <button>‚ûï Add Property</button>
                    </a>
                </p>
            </div>
            <div>
                <h3>Add New Tenant Name</h3>
                <form method="POST" action="{{ url_for('manage_tenant_post') }}">
                    <input type="hidden" name="action" value="add">
                    <input type="text" name="first_name" placeholder="First Name" required>
                    <input type="text" name="last_name" placeholder="Last Name" required>
                    <input type="number" name="contact_number" placeholder="Phone Number" required> <button type="submit">‚ûï Add Tenant</button>
                </form>
            </div>
            <div>
                <h3>Permanently Delete Tenant</h3>
                <form method="POST" action="{{ url_for('manage_tenant_post') }}">
                    <input type="hidden" name="action" value="delete">
                    <select name="tenant_id" required>
                        <option value="">-- Select Tenant to Delete --</option>
                        {% for tenant in tenants_list %}
                            <option value="{{ tenant.TenantID }}">{{ tenant.Name }} (ID: {{ tenant.TenantID }})</option>
                        {% endfor %}
                    </select>
                   <button type="submit" class="remove" 
                        onclick="return confirm('WARNING: This will permanently delete the tenant record and all associated history. This will also unassign the tenant from any properties.');">
                        Delete Record
                    </button>
                </form>
            </div>
        </div>    
        <h2>Properties List</h2>
        <table>
            <thead>
                <tr>
                    <th>Address</th>
                    <th>Monthly Rent</th>
                    <th>Current Tenant</th>
                    <th>Late Payments (Total)</th>
                    <th>Tenant Management</th>
                    <th>Management</th> 
                </tr>
            </thead>
            <tbody>
                {% for prop in properties %}
                <tr>
                    <td>{{ prop.Address }}</td>
                    <td>${{ '{:,.2f}'.format(prop.MonthlyRent) }}</td>
                    <td>{{ prop.TenantName if prop.TenantName else 'VACANT' }}</td>
                    <td class="{{ 'late' if late_counts_dict.get(prop.PropertyID, 0) > 0 else '' }}">
                        {{ late_counts_dict.get(prop.PropertyID, 0) }}
                    </td>
                    <td>
                        <form method="POST" action="{{ url_for('assign_tenant_post', property_id=prop.PropertyID) }}">
                            <select name="tenant_id" required>
                                <option value="0">-- VACANT --</option>
                                
                                {% for tenant in tenants_list %}
                                    <option value="{{ tenant.TenantID }}" 
                                            {% if prop.TenantID == tenant.TenantID %} selected {% endif %}>
                                        {{ tenant.Name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <input type="month" name="start_month" 
                                   value="{{ current_month_ym }}" 
                                   required style="width: 100px;">
                            <button type="submit">Assign/Update</button>
                        </form>
                    </td>    
                    <td>
                        <form method="POST" action="{{ url_for('manage_property_post') }}" style="margin-bottom: 5px;">
                            <input type="hidden" name="action" value="update">
                            <input type="hidden" name="property_id" value="{{ prop.PropertyID }}">
                            
                            <label>Addr:</label>
                            <input type="text" name="address" value="{{ prop.Address }}" required style="width: 100px;">
                            <label>Rent:</label>
                            <input type="number" step="0.01" name="monthly_rent" value="{{ '{:,.2f}'.format(prop.MonthlyRent) }}" required style="width: 80px;">
                            <button type="submit">Update Details</button>
                        </form>    
                        <form method="POST" action="{{ url_for('manage_property_post') }}">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="property_id" value="{{ prop.PropertyID }}">
                            <button type="submit" class="remove" 
                                onclick="return confirm('WARNING: Are you sure you want to permanently delete Property ID {{ prop.PropertyID }} ({{ prop.Address }})? This will delete all associated payment history.');">
                                Delete Property
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    {% elif page == 'add_property' %}
        <h2>‚ûï Add New Rental Property</h2>
        <p><a href="{{ url_for('single_page_app', page='properties') }}">Back to Properties List</a></p>
        <hr>    
        <form method="POST" action="{{ url_for('add_property_post') }}">
            <div>
                <label for="address">Property Address:</label>
                <input type="text" name="address" required>
            </div>
            <div>
                <label for="monthly_rent">Monthly Rent Amount:</label>
                <input type="number" step="0.01" name="monthly_rent" required>
            </div>
            <div>
                <label for="tenant_id">Assign Current Tenant:</label>
                <select name="tenant_id">
                    {% for tenant in tenants %}
                    <option value="{{ tenant.TenantID }}">{{ tenant.Name }}</option>
                    {% endfor %}
                </select>
                <small> (Select 'VACANT' if no tenant is currently assigned)</small>
            </div>
            <div>
                <button type="submit">Save Property</button>
            </div>
        </form>
        
    {% endif %}

</body>
</html>